@using AccountingSystem.Models

@{
    ViewBag.Title = "Fixed Assets";
    var user = (User)Session["loggedinUser"];
    var accessRights = user.AccessRight.Split(',');
}
@section styles
{
    <link href="~/Content/css/jquery-ui.css" rel="stylesheet" />
    <link href="~/Content/css/messi.min.css" rel="stylesheet" />
    <style>
        #from, #to {
            background: white;
            cursor: default;
        }

        .modal-header-fa {
            color: #fff;
            border-bottom: 1px solid #eee;
            background-color: #005BF1;
            -webkit-border-radius: 5px 5px 0px 0px;
            -moz-border-radius: 5px 5px 0px 0px;
            border-radius: 5px 5px 0px 0px;
            padding: 0px 5px 0px 5px;
            margin: -10px 0px 0px 0px;
        }

            .modal-header-fa h4 {
                color: #fff;
                line-height: 28px;
                font-size: 15px;
                margin: 2px 0px 0px 0px;
            }

            .modal-header-fa .close {
                color: #fff;
                font-size: 20px;
                line-height: 28px;
            }

        .faModal .modal-dialog {
            width: 800px;
        }

        .faModal .modal-body .row-top {
            margin: -5px 0px 0px 0px;
        }

            .faModal .modal-body .row-top .panel {
                margin: -5px -15px 10px -15px;
                padding: 0px 0px 0px 0px;
                border: 1px solid #666;
            }

        .panel legend.legendStyle {
            padding: 0px 5px 0px 5px;
            margin: 1px 0px 0px 0px;
            font-size: 90%;
            background-color: transparent;
            font-weight: bold;
        }

        .panel fieldset.fsStyle {
            border: 1px solid #999999;
            padding: 4px;
            margin: -5px 10px 0px 10px;
        }

        .panel legend {
            border-bottom: 0px;
            width: auto;
        }

        .panel fieldset label {
            font-size: 14px;
            font-weight: normal;
        }

        .noresize {
            resize: none;
        }

        .datepicker {
            z-index: 1151 !important;
        }

        .modal-footer .btn {
            padding: 5px 31px 5px 31px;
        }

        .modal-footer .btn-green {
            padding: 5px 31px 5px 31px;
            background: #99a100;
            border: 1px solid #818800;
            color: #FFF;
        }

            .modal-footer .btn-green:hover, .modal-footer .btn-green:hover {
                padding: 5px 31px 5px 31px;
                background: #99a100;
                border: 1px solid #818800;
                color: #FFF;
            }

        .full-width {
            display: block;
            padding: 6px 0px 6px 0px;
            background-color: #d6e5f8;
            color: #333;
            border: 1px solid #999;
        }

        .full-width-gray {
            display: block;
            padding: 6px 0px 6px 0px;
            background-color: #e4e1d0;
            color: #333;
            border: 1px solid #999;
        }

        .white_Label {
            background-color: #fff;
            color: #333;
        }

        .picker {
            z-index: 100000;
        }

        .ui-autocomplete {
            z-index: 2147483647;
        }

        .ui-autocomplete {
            max-height: 100px;
            overflow-y: auto;
            /* prevent horizontal scrollbar */
            overflow-x: hidden;
            /* add padding to account for vertical scrollbar */
            padding-right: 5px;
            font-size: 12px;
        }

        .ui-menu-divider {
            display: none;
        }
        /* IE 6 doesn't support max-height
        * we use height instead, but this forces the menu to always be this tall
        */
        * html .ui-autocomplete {
            height: 100px;
        }

        #disposal input, #disposal select, #disposal textarea {
            cursor: default;
        }

        #close {
            position: absolute;
            top: 0;
            right: 0px;
            background: url(../images/close2.png) no-repeat -25px 0;
            width: 30px;
            height: 30px;
            text-indent: -9999px;
            padding: 0 10px 0 0;
            cursor: pointer;
            margin: -8px 0 0 0;
        }
    </style>
}

<!-- Modal -->
<div class="modal faModal" id="success" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header modal-header-fa">
                <div id="close" aria-hidden="true"></div>
                <h4 class="nstitle"> <img alt="Fixed_asset_logo" src="~/image/Fixed_Asset.png" width="20" height="20">Fixed Assets</h4>
            </div>
            <div class="modal-body">
                <div class="row-top">
                    <div class="col-sm-12">
                        <div class="panel">
                            <div class="panel-body">
                                <div class="row" style="margin:-10px -15px 0px -15px;">
                                    <div class="col-sm-2">Asset No.</div>
                                    <div class="col-sm-3">
                                        <div class="form-group-sm">
                                            <div class="col-sm-12" style="padding: 0;">
                                                <input type="text" class="form-control input-sm pull-right select" id="assetCodes" style="cursor: default; padding-right: 0;" /><input type="hidden" id="assetid" />
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-sm-2" style="text-align: right;">Item Name</div>
                                    <div class="col-sm-5">
                                        <div class="form-group-sm">
                                            <select id="items" class="form-control">
                                                <option value="" data-name="" data-type="" data-assetname=""></option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <div class="row" style="margin:5px -15px 0px -15px;">
                                    <div class="col-sm-2">CER No.</div>
                                    <div class="col-sm-3">
                                        <div class="form-group-sm">
                                            <input name="cer no" type="text" class="form-control input-sm">
                                        </div>
                                    </div>
                                    <div class="col-sm-2">&nbsp;</div>
                                    <div class="col-sm-5">
                                        <button type="button" class="btn btn-info pull-left" id="purchase">Purchase New asset</button>
                                        <button type="button" class="btn btn-info pull-right">Add new item</button>
                                    </div>
                                </div>

                                <div class="row" style="margin:5px -15px 0px -15px;">
                                    <div class="col-sm-2">Asset type</div>
                                    <div class="col-sm-3">
                                        <span class="label label-default full-width text-center" id="assetType">&nbsp;&nbsp;&nbsp;&nbsp;</span>
                                    </div>
                                    <div class="col-sm-2">&nbsp;</div>
                                    <div class="col-sm-5">
                                        <span class="label label-default full-width text-center" id="assetElec">&nbsp;&nbsp;&nbsp;&nbsp;</span>
                                    </div>
                                </div>

                                <div class="row" style="margin:5px -15px 0px -15px;">
                                    <div class="col-sm-2">Memo</div>
                                    <div class="col-sm-10">
                                        <textarea class="form-control noresize" rows="2" style="height: 50px;" id="memo"></textarea>
                                    </div>
                                </div>

                                <div class="row" style="margin:5px -15px 0px -15px;">
                                    <div class="col-sm-3">
                                        <label class="label label-default white_Label text-center" style="cursor: pointer;">No depreciation <input type="checkbox" value="" style="vertical-align:text-bottom; margin:0px 0px 0px 5px;" id="depriciation"></label>
                                    </div>
                                    <div class="col-sm-9">
                                        &nbsp;
                                    </div>
                                </div>

                                <div class="row" style="margin:5px -10px 0px -15px;" id="clear">
                                    <div class="col-sm-4">
                                        <div class="row" style="margin:3px -15px 0px -15px;">
                                            <div class="col-sm-5" style="font-size:12px;padding-right: 0;">Purchased Date</div>
                                            <div class="col-sm-7">
                                                <input name="price" type="text" class="form-control input-sm select" id="purchaseDate" style="padding: 0 0 0 15px; cursor: default;">
                                            </div>
                                        </div>

                                        <div class="row" style="margin:3px -15px 0px -15px;">
                                            <div class="col-sm-5">Supplier</div>
                                            <div class="col-sm-7">
                                                <input type="text" class="form-control input-sm" size="1" id="supplier">
                                            </div>
                                        </div>

                                        <div class="row" style="margin:3px -15px 0px -15px;">
                                            <div class="col-sm-5">Invoice No.</div>
                                            <div class="col-sm-7">
                                                <input type="text" class="form-control input-sm" size="1" id="invoiceNo">
                                            </div>
                                        </div>

                                        <div class="row" style="margin:3px -15px 0px -15px;">
                                            <div class="col-sm-5">Label No.</div>
                                            <div class="col-sm-7">
                                                <input type="text" class="form-control input-sm" size="1" id="labelNo">
                                            </div>
                                        </div>

                                        <div class="row" style="margin:3px -15px 0px -15px;">
                                            <div class="col-sm-5" style="font-size:11px;">Purchased By</div>
                                            <div class="col-sm-7">
                                                <div class="form-group-sm">
                                                    <select id="purchaseBanks" class="form-control"></select>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-sm-4">
                                        <div class="row" style="margin:5px -15px 0px -15px;">
                                            <div class="col-sm-6">Price</div>
                                            <div class="col-sm-6">
                                                <input name="price" type="text" class="form-control input-sm" id="price">
                                            </div>
                                        </div>

                                        <div class="row" style="margin:5px -15px 0px -15px;">
                                            <div class="col-sm-6" style="font-size:12px">Dep. Start Date</div>
                                            <div class="col-sm-6">
                                                <input name="price" type="text" class="form-control input-sm picker select" id="depStartDate" style="padding: 0 0 0 7px; cursor: default;">
                                            </div>
                                        </div>

                                        <div class="row" style="margin:5px -15px 0px -15px;">
                                            <div class="col-sm-6">Dep. Life</div>
                                            <div class="col-sm-6">
                                                <div class="col-sm-6" style="padding-left: 0; margin-right: -1px;;">
                                                    <input type="text" class="form-control input-sm" style="padding: 0 0 0 2px;" maxlength="2" size="2" id="depLife">
                                                </div>months
                                            </div>
                                        </div>

                                        <div class="row" style="margin:5px -15px 0px -15px;">
                                            <div class="col-sm-6" style="font-size:12px">Dep. Rate</div>
                                            <div class="col-sm-6">
                                                <span class="label label-default full-width text-center" id="depRate">&nbsp;</span>
                                            </div>
                                        </div>

                                        <div class="row" style="margin:5px -15px 0px -15px;">
                                            <div class="col-sm-6" style="font-size:12px">Dep. End Date</div>
                                            <div class="col-sm-6">
                                                <span class="label label-default full-width text-center" id="depEndDate">&nbsp;</span>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-sm-4">
                                        <div class="panel" style="margin:5px -15px 5px -15px;">
                                            <div class="row" style="margin:20px 0px 5px 0px;">
                                                <div class="col-sm-5">Start Date</div>
                                                <div class="col-sm-7">
                                                    <span class="label label-default full-width-gray text-center" id="startDate">&nbsp;</span>
                                                </div>
                                            </div>

                                            <div class="row" style="margin:8px 0px 5px 0px;">
                                                <div class="col-sm-5">End Date</div>
                                                <div class="col-sm-7">
                                                    <span class="label label-default full-width-gray text-center" id="endDate">&nbsp;</span>
                                                </div>
                                            </div>

                                            <div class="row" style="margin:8px 0px 5px 0px;">
                                                <div class="col-sm-5">Acc. Dep</div>
                                                <div class="col-sm-7">
                                                    <span class="label label-default full-width-gray text-center" id="accDep">&nbsp;</span>
                                                </div>
                                            </div>

                                            <div class="row" style="margin:8px 0px 20px 0px;">
                                                <div class="col-sm-5">Curr. Value</div>
                                                <div class="col-sm-7">
                                                    <span class="label label-default full-width-gray text-center" id="currValue">&nbsp;</span>
                                                </div>
                                            </div>

                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <fieldset class="fsStyle" id="disposal">
                                        <legend class="legendStyle">
                                            Disposal
                                        </legend>
                                        <div class="row">
                                            <div class="col-sm-2">
                                                <form role="form">
                                                    <div class="radio" style="margin:20px 0px 0px 10px;">
                                                        <label style="cursor: default;"><input name="radio" id="resale" checked value="1" type="radio">Resale</label>
                                                    </div>
                                                    <div class="radio" style="margin:40px 0px 0px 10px;">
                                                        <label style="cursor: default;"><input name="radio" id="damage" value="0" type="radio">Damage</label>
                                                    </div>
                                                </form>
                                            </div>
                                            <div class="col-sm-3">
                                                <form role="form">
                                                    <div>
                                                        <label>Amount</label>
                                                        <input type="text" class="form-control input-sm" maxlength="4" size="1" id="amount">
                                                    </div>
                                                    <div>
                                                        <label>Resale By</label>
                                                        <select id="resaleBanks" class="form-control">
                                                            <option value=""></option>
                                                        </select>
                                                    </div>
                                                </form>
                                            </div>
                                            <div class="col-sm-3">
                                                <label>Remarks</label>
                                                <textarea class="form-control noresize" rows="3" id="remarks"></textarea>
                                            </div>
                                            <div class="col-sm-2">
                                                <label>Month</label>
                                                <select class="form-control" id="month">
                                                    <option value=""></option>
                                                    <option value="1">January</option>
                                                    <option value="2">February</option>
                                                    <option value="3">March</option>
                                                    <option value="4">April</option>
                                                    <option value="5">May</option>
                                                    <option value="6">June</option>
                                                    <option value="7">July</option>
                                                    <option value="8">August</option>
                                                    <option value="9">September</option>
                                                    <option value="10">October</option>
                                                    <option value="11">November</option>
                                                    <option value="12">December</option>
                                                </select>
                                                <label>Year</label>
                                                <select class="form-control input-sm" id="year">
                                                    <option></option>
                                                    @for (var i = DateTime.Now.Year; i >= 2000; i--)
                                                    {
                                                        <option value="@i">@i</option>
                                                    }
                                                </select>
                                            </div>
                                            <div class="col-sm-2">
                                                <div style="margin:25px 0px 5px 0px;">
                                                    <button type="button" class="btn btn-info" id="submitDisposal">Submit</button>
                                                </div>
                                                <div style="margin:30px 0px 5px 0px;">
                                                    <button type="button" class="btn btn-info" id="deleteDisposal">Delete&nbsp;</button>
                                                </div>
                                            </div>
                                        </div>
                                    </fieldset>
                                </div>

                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="border: none;">
                <button type="button" class="btn btn-primary pull-left" id="insert"><strong>Insert</strong></button>
                <button type="button" class="btn btn-primary pull-left" id="update"><strong>Update</strong></button>
                <button type="button" class="btn btn-primary pull-left" id="delete"><strong>Delete</strong></button>
                <button type="button" class="btn btn-primary pull-left" id="make"><strong>Make journal</strong></button>
                <button type="button" class="btn btn-primary pull-right" id="exit"><strong>Exit</strong></button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->
<!-- Modal -->
@section scripts
{
    <script src="~/Scripts/jquery-ui-1.11.4.js"></script>
    <script src="~/Scripts/js/messi.min.js"></script>
    <script>
        $(document).ready(function () {
            $(window).on('load', function () {
                $("#success").modal({
                    backdrop: 'static',
                    keyboard: false
                });
            });
            $("#purchaseDate, #depStartDate").datepicker({
                changeMonth: true,
                changeYear: true
            });
            var enforceModalFocusFn = $.fn.modal.Constructor.prototype.enforceFocus;
            $.fn.modal.Constructor.prototype.enforceFocus = function () { };
            var today = new Date();
            var todayDate = (today.getMonth() + 1) + "/" + today.getDate() + "/" + today.getFullYear();
            $("#purchaseDate, #depStartDate").val('@DateTime.Now.ToString("MM/dd/yyyy")');
            function centerSuccess() {
                $(".modal").css('display', 'block');
                var $dialog = $('.modal').find(".modal-dialog");
                var offset = ($(window).height() - $dialog.height()) / 2;
                // Center modal vertically in window
                $dialog.css("margin-top", offset);
            }

            centerSuccess();
            $(window).on("resize", function () {
                centerSuccess();
            });
            //$(document).click(function () {
            //    $('#success').modal('show');
            //});
            //$(document).on('keydown', function (e) {
            //    if (e.keyCode == 27)
            //        $('#success').modal('show');
            //});
            $("#insert, #update, #delete, #make, #disposal, #purchase").prop('disabled', true);
            function load(assetnumber) {
                $.ajax({
                    type: "Post",
                    url: '@Url.Action("GetFixedAssetInitialData", "Sale")',
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    success: function (data) {
                        var assetCodes = [];
                        $.each(data.AssetCodes, function (key, value) {
                            assetCodes.push({ Id: value.Id, value: value.Name });
                        });
                        $("#items").html('');
                        $("#items").append('<option value="" data-type="" data-name=""></option>');
                        $.each(data.AssetItems, function (key1, value1) {
                            if (assetnumber == value1.ItemId)
                                $("#items").append('<option selected value="' + value1.ItemId + '" data-type="' + value1.AssetType + '" data-name="' + value1.AssetName + '">' + value1.ItemName + '</option>');
                            else
                                $("#items").append('<option value="' + value1.ItemId + '" data-type="' + value1.AssetType + '" data-name="' + value1.AssetName + '">' + value1.ItemName + '</option>');
                        });
                        $("#purchaseBanks, #resaleBanks").html('');
                        $("#resaleBanks").append('<option value=""></option>');
                        $.each(data.BankList, function (key2, value2) {
                            $("#purchaseBanks, #resaleBanks").append('<option value="' + value2.Id + '">' + value2.Name + '</option>');

                        });

                        $("#assetCodes").autocomplete({
                            source: assetCodes,
                            minLength: 0,
                            select: function (event, ui) {
                                $("#assetid").val(ui.item.Id);
                                $.ajax({
                                    type: "Post",
                                    url: '@Url.Action("GetAssetInfo", "Sale")',
                                    contentType: "application/json; charset=utf-8",
                                    data: JSON.stringify({ assetCode: ui.item.value }),
                                    dataType: "json",
                                    success: function (dt) {
                                        $('#items option[value="' + dt.AssetNo + '"]').prop('selected', true);
                                        $("#assetType").html($("#items option:selected").data('type'));
                                        $("#assetElec").html($("#items option:selected").data('name'));
                                        $("#purchase").prop('disabled', false);
                                        $("#memo").val(dt.Description);
                                        $("#depriciation").prop('checked', dt.NoDep);
                                        $("#purchaseDate").val(dt.PurchasedDate);
                                        $("#depStartDate").val(dt.DepStartDate);
                                        $("#price").val(dt.Price.toFixed(2));
                                        $("#depLife").val(dt.DepLife);
                                        $("#depRate").html(dt.DepRate.toFixed(2));
                                        if (dt.DepEndDate != null)
                                            $("#depEndDate, #endDate").html(dt.DepEndDate);
                                        $("#startDate").html(dt.DepStartDate);
                                        if (dt.LastPosted == null) {
                                            $("#accDep").html('0.00');
                                            $("#currValue").html(dt.Price.toFixed(2));
                                            $("#make").prop('disabled', false);
                                        } else {
                                            var d1 = dt.DepStartDate.split('/');
                                            var d2 = dt.LastPosted.split('/');
                                            var m = (d2[2] - d1[2]) * 12 + (d2[0] - d1[0]) + 1;
                                            var rate = Math.round(m * dt.DepRate);
                                            $("#accDep").html(rate.toFixed(2));
                                            $("#currValue").html(Math.round(parseFloat(dt.Price - rate)).toFixed(2));
                                            if (d2[0] == (today.getMonth() + 1))
                                                $("#make").prop('disabled', true);
                                            else
                                                $("#make").prop('disabled', false);
                                        }
                                        $("#supplier").val(dt.Supplier);
                                        $("#invoiceNo").val(dt.InvoiceNo);
                                        $("#labelNo").val(dt.LabelNo);
                                        if (dt.DisposalDate == null)
                                            clearDisposal();
                                        else {
                                            if (parseInt(dt.SoldAmount) > 0) {
                                                $("#resale").prop('checked', true);
                                                $("#amount").val(dt.SoldAmount);
                                            } else
                                                $("#damage").prop('checked', true);
                                            $("#remarks").val(dt.Remarks);
                                            var disposalDate = dt.DisposalDate.split('/');
                                            $('#month option[value="' + disposalDate[0] + '"]').prop('selected', true);
                                            $('#year option[value="' + disposalDate[2] + '"]').prop('selected', true);
                                        }
                                        $("#update, #delete, #disposal").prop('disabled', false);
                                        $("#insert").prop('disabled', true);
                                    },
                                });
                                $(this).blur();
                            }
                        }).focus(function () {
                            $(this).autocomplete("search", "");
                        });
                    },
                });
            }

            load(-100);

            function clearDisposal() {
                $("#amount, #resaleBanks, #remarks, #month, #year").val('');
                $("#submitDisposal, #deleteDisposal").prop('disabled', false);
            }

            $("#items").on('change', function () {
                $("#assetType").html($("#items option:selected").data('type'));
                $("#assetElec").html($("#items option:selected").data('name'));
                $("#purchase").prop('disabled', false);
            });
            $("#purchase").on('click', function () {
                $.ajax({
                    type: "Post",
                    url: '@Url.Action("GetGeneratedAssetCode", "Sale")',
                    contentType: "application/json; charset=utf-8",
                    data: JSON.stringify({ id: $("#items option:selected").data('type'), assettype: $("#items option:selected").data('name').substring(0, 3) }),
                    dataType: "json",
                    success: function (data) {
                        $("#assetCodes").val(data);
                        clearDisposal();
                        $("#update, #delete, #make, #disposal").prop('disabled', true);
                        $("#insert").prop('disabled', false);
                        $("#purchaseDate, #depStartDate").val(todayDate);
                        $("#supplier, #invoiceNo, #labelNo, #price, #depLife").val('');
                        $("#depRate, #depEndDate, #startDate, #endDate, #accDep, #currValue").html('&nbsp;&nbsp;&nbsp;&nbsp; ');
                    },
                });
            });
            function checkAllAreSpaces(str) {
                var isSpace = true;
                for (var l = 0; l < str.length; l++) {
                    var ch = str[l];
                    if (ch != " ")
                        isSpace = false;
                }
                return isSpace;
            }
            $("#insert, #update").on('click', function () {
                var action = $(this).text().toUpperCase();
                var userId = '@user.UserId';
                var noDep = $("#depriciation").is(':checked') ? 1 : 0;
                var assetCode = $("#assetCodes").val();
                var assetNo = $("#items").val();
                var assetType = $("#assetType").text();
                var purchasedDate = $("#purchaseDate").val();
                var purdt = purchasedDate.split('/');
                var purdate = new Date(purdt[2], (purdt[0] - 1), purdt[1]);
                var price = $("#price").val();
                var depStartDate = $("#depStartDate").val();
                var strdt = depStartDate.split('/');
                var strdate = new Date(strdt[2], (strdt[0] - 1), strdt[1]);
                var supplier = $("#supplier").val();
                var invoiceNo = $("#invoiceNo").val();
                var labelNo = $("#labelNo").val();
                var description = $("#memo").val();
                var depRate = $("#depRate").text();
                var depLife = $("#depLife").val();
                var depEndDate = $("#depEndDate").text();
                var right = 0;
                if (action == "INSERT") {
                    if ('@accessRights.Contains("1")' != 'True') {
                        var m1 = new Messi('Sorry, You have no permission to add a record.',
                        {
                            title: 'Alert',
                            modal: true,
                            buttons: [
                                    { id: 0, label: 'OK', val: 'X' }
                            ]
                        });
                        $('.messi-actions').css('float', 'left').css('margin-left', '205px');
                        right = 1;
                    }
                } else {
                    if ('@accessRights.Contains("2")' != 'True') {
                        var m0 = new Messi('Sorry, You have no permission to update a record.',
                        {
                            title: 'Alert',
                            modal: true,
                            buttons: [
                                    { id: 0, label: 'OK', val: 'X' }
                            ]
                        });
                        $('.messi-actions').css('float', 'left').css('margin-left', '205px');
                        right = 1;
                    }
                }
                if (right == 0) {
                    if (assetCode == "") {
                        var m2 = new Messi('Asset No. field can not be left blank.',
                        {
                            title: 'Alert',
                            modal: true,
                            buttons: [
                                    { id: 0, label: 'OK', val: 'X' }
                            ]
                        });
                        $('.messi-actions').css('float', 'left').css('margin-left', '205px');
                        $("#items").focus();
                    } else if (assetCode.indexOf('-') == -1) {
                        var m3 = new Messi("Asset Number is not in a valid format.<br/>Valid format of Asset number is '***-####'",
                        {
                            title: 'Alert',
                            modal: true,
                            buttons: [
                                    { id: 0, label: 'OK', val: 'X' }
                            ]
                        });
                        $('.messi-actions').css('float', 'left').css('margin-left', '205px');
                    } else {
                        var str = assetCode.split('-');
                        if (str[0] != $("#assetElec").text().substring(0, 3) || !$.isNumeric(str[1])) {
                            var m4 = new Messi("Asset Number is not in a valid format.<br/>Valid format of Asset number is '***-####'",
                            {
                                title: 'Alert',
                                modal: true,
                                buttons: [
                                    { id: 0, label: 'OK', val: 'X' }
                                ]
                            });
                            $('.messi-actions').css('float', 'left').css('margin-left', '205px');
                        } else if (price == "" || checkAllAreSpaces(price) || price == '0.00') {
                            var m5 = new Messi("You must give the amount of price for the item.",
                            {
                                title: 'Alert',
                                modal: true,
                                buttons: [
                                    { id: 0, label: 'OK', val: 'X' }
                                ]
                            });
                            $('.messi-actions').css('float', 'left').css('margin-left', '205px');
                        } else if (noDep == 0 && purdate > strdate) {
                            var m6 = new Messi("Depreciation date cannot be started before purchase date.",
                            {
                                title: 'Alert',
                                modal: true,
                                buttons: [
                                    { id: 0, label: 'OK', val: 'X' }
                                ]
                            });
                            $('.messi-actions').css('float', 'left').css('margin-left', '205px');
                        } else if (noDep == 0 && (depLife == "" || checkAllAreSpaces(depLife))) {
                            var m7 = new Messi("You must give the depreciation life for this item.",
                            {
                                title: 'Alert',
                                modal: true,
                                buttons: [
                                    { id: 0, label: 'OK', val: 'X' }
                                ]
                            });
                            $('.messi-actions').css('float', 'left').css('margin-left', '205px');
                        } else {
                            if (noDep == 1) {
                                depLife = 0;
                                depRate = 0;
                                depEndDate = "";
                            }
                            var jsonData = { action: action, userId: userId, noDep: noDep, assetCode: assetCode, assetNo: assetNo, assetType: assetType, purchasedDate: purchasedDate, price: price, depStartDate: depStartDate, supplier: supplier, invoiceNo: invoiceNo, labelNo: labelNo, description: description, depRate: depRate, depLife: depLife, depEndDate: depEndDate };
                            $.ajax({
                                type: "Post",
                                url: '@Url.Action("InsertUpdateAsset", "Sale")',
                                contentType: "application/json; charset=utf-8",
                                data: JSON.stringify(jsonData),
                                dataType: "json",
                                success: function (data) {
                                    if (data == true) {
                                        $("#update, #delete").prop('disabled', false);
                                        $("#insert").prop('disabled', true);
                                        if (noDep == 0)
                                            $("#make").prop('disabled', false);
                                        load(assetNo);
                                        var msg = new Messi('All information has been added to database successfully.',
                                        {
                                            title: 'Success',
                                            modal: true,
                                            buttons: [
                                    { id: 0, label: 'OK', val: 'X' }
                                            ]
                                        });
                                        $('.messi-actions').css('float', 'left').css('margin-left', '205px');
                                    }
                                },
                            });
                        }
                    }
                }

            });

            $("#depStartDate").on('keypress keydown keyup', function () {
                return false;
            });

            $("#depLife, #price").on('focusout', function () {
                if ($("#depLife").val() != "" && $("#price").val() != "" && !checkAllAreSpaces($("#depLife").val()) && !checkAllAreSpaces($("#price").val())) {
                    var deprate = parseFloat($("#price").val()) / parseFloat($("#depLife").val());
                    var dep = $("#depStartDate").val().split('/');
                    var depEndDate = new Date(dep[2], (dep[0] - 1), dep[1]);
                    depEndDate.setMonth(depEndDate.getMonth() + parseInt($("#depLife").val()));
                    depEndDate.setDate(depEndDate.getDate() - 1);
                    //alert(Date.isLeapYear(depEndDate));
                    var endDate = (depEndDate.getMonth() + 1) + "/" + depEndDate.getDate() + "/" + depEndDate.getFullYear();
                    $("#depRate").html(deprate.toFixed(2));
                    $("#depEndDate").html(endDate);
                }
                if ($("#price").val() == "")
                    $("#price").val('0.00');
                else if (checkAllAreSpaces($("#price").val()))
                    $("#price").val('0.00');
                else
                    $("#price").val(parseFloat($("#price").val()).toFixed(2));
            });

            $("#depriciation").on('change', function () {
                if ($(this).is(':checked'))
                    $("#depLife, #depRate, #depEndDate").prop('disabled', true);
                else
                    $("#depLife, #depRate, #depEndDate").prop('disabled', false);
            });
            $('input:radio[name="radio"]').on('change', function () {
                if ($(this).val() == 0) {
                    $("#amount,#resaleBanks").prop('disabled', false);
                } else {
                    $("#amount,#resaleBanks").prop('disabled', true);
                }
            });

            $("#make").on('click', function () {
                var userId = '@user.UserId';
                var noDep = $("#depriciation").is(':checked') ? 1 : 0;
                var assetCode = $("#assetCodes").val();
                var assetNo = $("#items").val();
                var price = $("#price").val();
                var description = $("#memo").val();
                if ('@accessRights.Contains("1")' != 'True') {
                    var m1 = new Messi('Sorry, You have no permission to make journal.',
                    {
                        title: 'Alert',
                        modal: true,
                        buttons: [
                                    { id: 0, label: 'OK', val: 'X' }
                        ]
                    });
                    $('.messi-actions').css('float', 'left').css('margin-left', '205px');
                }
                else if (assetCode == "" || checkAllAreSpaces(assetCode)) {
                    var m2 = new Messi('You must write or select an Asset Number.',
                    {
                        title: 'Alert',
                        modal: true,
                        buttons: [
                                    { id: 0, label: 'OK', val: 'X' }
                        ]
                    });
                    $('.messi-actions').css('float', 'left').css('margin-left', '205px');
                } else {
                    $.ajax({
                        type: "Post",
                        url: '@Url.Action("CheckAssetNumber", "Sale")',
                        contentType: "application/json; charset=utf-8",
                        data: JSON.stringify({ assetCode: assetCode }),
                        dataType: "json",
                        success: function (data) {
                            if (data == "") {
                                var m3 = new Messi("<p style='text-align: justify;'>The Asset Number '" + assetCode + "' is not found in database. Make sure that the Asset Number you have given is spelled correctly.</p>",
                                {
                                    title: 'Alert',
                                    modal: true,
                                    buttons: [
                                    { id: 0, label: 'OK', val: 'X' }
                                    ]
                                });
                                $('.messi-actions').css('float', 'left').css('margin-left', '205px');
                            } else {
                                var tno = data.Id;
                                if (data.LastPosted == null) {
                                    journalConfirmation(userId, noDep, assetCode, assetNo, $("#purchaseBanks option:selected").val(), price, description);
                                }
                                else if ($("#depriciation").is(':checked')) {
                                    var m4 = new Messi("<p style='text-align: justify;'>All Journal entry of this asset has been posted before.<br/>You need not post it again.</p>",
                                    {
                                        title: 'Confirmation',
                                        modal: true,
                                        buttons: [
                                    { id: 0, label: 'OK', val: 'X' }
                                        ]
                                    });
                                    $('.messi-actions').css('float', 'left').css('margin-left', '205px');
                                } else {
                                    var date = data.LastPosted.split('/');
                                    var date1 = data.DepEndDate.split('/');
                                    if (date[0] == (today.getMonth() + 1)) {
                                        var m5 = new Messi("<p style='text-align: justify;'>Journal entry for this month is already posted.<br/>You need not post it again.</p>",
                                        {
                                            title: 'Confirmation',
                                            modal: true,
                                            buttons: [
                                    { id: 0, label: 'OK', val: 'X' }
                                            ]
                                        });
                                        $('.messi-actions').css('float', 'left').css('margin-left', '205px');
                                    }
                                    else if (date[0] == date1[0] && date[2] == date1[2]) {
                                        var m6 = new Messi("<p style='text-align: justify;'>All Journal entry of this asset has been posted before.<br/>You need not post it again.</p>",
                                        {
                                            title: 'Confirmation',
                                            modal: true,
                                            buttons: [
                                    { id: 0, label: 'OK', val: 'X' }
                                            ]
                                        });
                                        $('.messi-actions').css('float', 'left').css('margin-left', '205px');
                                    }
                                }
                            }
                        },
                    });
                }
            });

            function journalConfirmation(userId, nodep, assetCode, assetNo, purchasedId, price, description) {
                var c = 0;
                var msg = new Messi('Did asset purchase by ' + $("#purchaseBanks option:selected").text() + '?',
                {
                    title: 'Confirm',
                    modal: true,
                    buttons: [
                        { id: 0, label: 'Yes', val: 'Y' },
                        { id: 1, label: 'No', val: 'N' }
                    ],
                    callback: function (val) {
                        if (c == 1)
                            return false;
                        if (val == 'Y') {
                            var jsonData = { userId: userId, nodep: nodep, assetCode: assetCode, assetNo: assetNo, purchasedId: purchasedId, price: price, description: description };
                            makeJournal(jsonData);
                            c = 1;
                        }
                        return true;
                    }
                });
            }
            function makeJournal(jsonData) {
                $.ajax({
                    type: "Post",
                    url: '@Url.Action("MakeAssetJournal", "Sale")',
                    contentType: "application/json; charset=utf-8",
                    data: JSON.stringify(jsonData),
                    dataType: "json",
                    success: function (dt) {
                        if (dt == true) {
                            var m0 = new Messi("<p style='text-align: justify;'>The Journal Entry is successfull.</p>",
                            {
                                title: 'Success',
                                modal: true,
                                buttons: [
                                    { id: 0, label: 'OK', val: 'X' }
                                ]
                            });
                            $('.messi-actions').css('float', 'left').css('margin-left', '205px');
                        }
                    },
                });
            }
            $("#submitDisposal").on('click', function () {
                var userId = '@user.UserId';
                var month = $("#month option:selected").val();
                var year = $("#year option:selected").val();
                if (month == "") {
                    var m1 = new Messi("<p style='text-align: justify;'>Invalid month.</p>",
                    {
                        title: 'Alert',
                        modal: true,
                        buttons: [
                                    { id: 0, label: 'OK', val: 'X' }
                        ]
                    });
                    $('.messi-actions').css('float', 'left').css('margin-left', '205px');
                    $("#month").focus();
                }
                else if (year == "") {
                    var m2 = new Messi("<p style='text-align: justify;'>Invalid year.</p>",
                    {
                        title: 'Alert',
                        modal: true,
                        buttons: [
                                    { id: 0, label: 'OK', val: 'X' }
                        ]
                    });
                    $('.messi-actions').css('float', 'left').css('margin-left', '205px');
                    $("#year").focus();
                }
                else if ($("#resale").is(':checked') && $("#amount").val() == "") {
                    var m3 = new Messi("<p style='text-align: justify;'>Invalid resale price.</p>",
                    {
                        title: 'Alert',
                        modal: true,
                        buttons: [
                                    { id: 0, label: 'OK', val: 'X' }
                        ]
                    });
                    $('.messi-actions').css('float', 'left').css('margin-left', '205px');
                    $("#amount").focus();
                }
                else if ($("#resale").is(':checked') && $("#resaleBanks option:selected").val() == "") {
                    var m4 = new Messi("<p style='text-align: justify;'>Invalid item for Resale by.</p>",
                    {
                        title: 'Alert',
                        modal: true,
                        buttons: [
                                    { id: 0, label: 'OK', val: 'X' }
                        ]
                    });
                    $('.messi-actions').css('float', 'left').css('margin-left', '205px');
                    $("#resaleBanks").focus();
                } else {
                    var msg = new Messi('Do you want to DISPOSE this asset?',
                    {
                        title: 'Confirm',
                        modal: true,
                        buttons: [
                            { id: 0, label: 'Yes', val: 'Y' },
                            { id: 1, label: 'No', val: 'N' }
                        ],
                        callback: function (val) {
                            if (val == 'Y') {
                                var assetNoId = $("#assetid").val();
                                var disposalDate = month + "/1/" + year;
                                var jsonData = { userId: userId, assetNoId: assetNoId, disposalDate: disposalDate, amount: $("#amount").val(), sold: $('input:radio[name="radio"]').val(), description: $("#remarks").val(), soldId: $("#resaleBanks option:selected").val() };
                                $.ajax({
                                    type: "Post",
                                    url: '@Url.Action("InsertDisposalAsset", "Sale")',
                                    contentType: "application/json; charset=utf-8",
                                    data: JSON.stringify(jsonData),
                                    dataType: "json",
                                    success: function (d) {
                                        if (d == true) {
                                            var m10 = new Messi("<p style='text-align: justify;'>Disposal Entry succeeded.</p>",
                                            {
                                                title: 'Alert',
                                                modal: true,
                                                buttons: [
                                    { id: 0, label: 'OK', val: 'X' }
                                                ]
                                            });
                                            $('.messi-actions').css('float', 'left').css('margin-left', '205px');
                                        }
                                    },
                                });
                            }
                        }
                    });
                }
            });
            $("#delete").on('click', function () {
                var userId = '@user.UserId';
                var noDep = $("#depriciation").is(':checked') ? 1 : 0;
                var assetCode = $("#assetCodes").val();
                var assetNo = $("#items").val();
                var price = $("#price").val();
                var description = $("#memo").val();
                if ('@accessRights.Contains("3")' != 'True') {
                    var m1 = new Messi('Sorry, You have no permission to delete a record.',
                    {
                        title: 'User Access Control',
                        modal: true,
                        buttons: [
                                    { id: 0, label: 'OK', val: 'X' }
                        ]
                    });
                    $('.messi-actions').css('float', 'left').css('margin-left', '205px');
                }
                else if (assetCode == "") {
                    var m2 = new Messi('You must write or select an Asset Number.',
                    {
                        title: 'Alert',
                        modal: true,
                        buttons: [
                                    { id: 0, label: 'OK', val: 'X' }
                        ]
                    });
                    $('.messi-actions').css('float', 'left').css('margin-left', '205px');
                } else {
                    var c = 0;
                    var msg = new Messi('Are you sure you want to delete the information of<br/>Asset number ' + assetCode + '?',
                    {
                        title: 'Confirm',
                        modal: true,
                        buttons: [
                            { id: 0, label: 'Yes', val: 'Y' },
                            { id: 1, label: 'No', val: 'N' }
                        ],
                        callback: function (val) {
                            if (c == 1)
                                return false;
                            if (val == 'Y') {
                                var jsonData = { assetCode: assetCode };
                                $.ajax({
                                    type: "Post",
                                    url: '@Url.Action("CheckAssetNumber", "Sale")',
                                    contentType: "application/json; charset=utf-8",
                                    data: JSON.stringify(jsonData),
                                    dataType: "json",
                                    success: function (dt) {
                                        if (dt == "") {
                                            var m3 = new Messi("<p style='text-align: justify;'>The Asset Number '" + l + "' is not found in database. Make sure that the Asset Number you have given is spelled correctly.</p>",
                                            {
                                                title: 'Alert',
                                                modal: true,
                                                buttons: [
                                    { id: 0, label: 'OK', val: 'X' }
                                                ]
                                            });
                                            $('.messi-actions').css('float', 'left').css('margin-left', '205px');
                                        } else if (dt.LastPosted != null) {
                                            var m4 = new Messi("<p style='text-align: justify;'>Can not delete this item. Some journal entry of this purchase item is already posted.</p>",
                                            {
                                                title: 'Alert',
                                                modal: true,
                                                buttons: [
                                    { id: 0, label: 'OK', val: 'X' }
                                                ]
                                            });
                                            $('.messi-actions').css('float', 'left').css('margin-left', '205px');
                                        } else {
                                            $.ajax({
                                                type: "Post",
                                                url: '@Url.Action("DeleteAssetJournal", "Sale")',
                                                contentType: "application/json; charset=utf-8",
                                                data: JSON.stringify(jsonData),
                                                dataType: "json",
                                                success: function (d) {
                                                    if (d == true) {
                                                        $("#assetCodes,#items").val('');
                                                        $("#insert, #update, #delete, #make, #disposal, #purchase").prop('disabled', true);
                                                        $("#memo").val('');
                                                        $("#purchaseDate, #depStartDate").val(todayDate);
                                                        $("#supplier, #invoiceNo, #labelNo, #price, #depLife,#assetid").val('');
                                                        $("#depRate, #depEndDate, #startDate, #endDate, #accDep, #currValue, #assetElec, #assetType").html('&nbsp;&nbsp;&nbsp;&nbsp; ');
                                                        clearDisposal();
                                                        $("#resale").prop('checked', true);
                                                        $("#amount,#resaleBanks,#remarks,#month,#year").val('');
                                                        load(-100);
                                                        var m10 = new Messi("<p style='text-align: justify;'>Delete succeeded.</p>",
                                                        {
                                                            title: 'Alert',
                                                            modal: true,
                                                            buttons: [
                                    { id: 0, label: 'OK', val: 'X' }
                                                            ]
                                                        });
                                                        $('.messi-actions').css('float', 'left').css('margin-left', '205px');
                                                    }
                                                },
                                            });
                                        }
                                    },
                                });
                                c = 1;
                            }
                            return true;
                        }
                    });
                }
            });
            $("#exit,#close").on('click', function () {
                $("#success").modal('hide');
            });
        });
    </script>
}
