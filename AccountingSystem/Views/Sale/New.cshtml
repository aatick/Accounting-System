@using AccountingSystem.Models
@using AccountingSystem.Models.ViewModel
@{
    ViewBag.Title = "New Sale";
    var user = (User)Session["loggedinUser"];
    var accessRights = user.AccessRight.Split(',');
    var companyid = 0;
    var onlineJobId = 0;
    var onlineLedgerId = 0;
    var onlineCompanyId = 0;
    if (ViewBag.Online != null)
    {
        companyid = Convert.ToInt32(ViewBag.Online[2]);
        onlineJobId = ViewBag.Online[1];
        onlineLedgerId = ViewBag.Online[0];
        onlineCompanyId = ViewBag.Online[2];
    }
}
@section styles
{
    <link href="~/Content/css/jquery-ui.css" rel="stylesheet" />
    <link href="~/Content/css/dataTables.jqueryui.css" rel="stylesheet" />
    <link href="~/Content/css/messi.min.css" rel="stylesheet" />

    <style type="text/css">
        .modal-header-ns {
            color: #fff;
            border-bottom: 1px solid #eee;
            background-color: #005BF1;
            -webkit-border-radius: 5px 5px 0px 0px;
            -moz-border-radius: 5px 5px 0px 0px;
            border-radius: 5px 5px 0px 0px;
            padding: 0px 5px 0px 5px;
            margin: -10px 0px 0px 0px;
        }

            .modal-header-ns h4 {
                color: #fff;
                line-height: 28px;
                font-size: 15px;
                margin: 2px 0px 0px 0px;
            }

            .modal-header-ns .close {
                color: #fff;
                font-size: 20px;
                line-height: 28px;
            }

        .nsModal .modal-dialog {
            width: 800px;
            margin-top: 2px;
        }

        .nsModal .modal-body .row-top {
            margin: -10px -15px 10px -15px;
            padding: 0px 0px 0px 0px;
        }

        .nsModal .modal-footer {
            border-top: none;
        }

        .btn-ash {
            background: #dfe0e2;
            border: 1px solid #bebaaf;
        }

            .btn-ash:hover, .panel .btn-ash:focus {
                background-color: #dfe0e2;
            }

        legend.legendStyle {
            padding: 0px 5px 0px 5px;
            margin: 1px 0px 0px 0px;
            font-size: 90%;
            background-color: transparent;
            font-weight: bold;
        }

        fieldset.fsStyle {
            border: 1px solid #999999;
            padding: 4px;
            margin: 10px 0px 5px 0px;
        }

        legend {
            border-bottom: 0px;
            width: auto;
        }

        fieldset label {
            font-size: 14px;
            font-weight: normal;
        }

        .noresize {
            resize: none;
        }

        #dp1, #dp2, #workshopdate {
            cursor: default;
        }

        input[type="text"], #Type {
            height: 18px;
            padding-top: 0;
            padding-bottom: 0;
            line-height: normal;
        }

        #jobTitle, #billingPerson {
            cursor: default;
        }

        .aright {
            text-align: right;
        }

        .acenter {
            text-align: center;
        }

        .input-sm + .form-control-feedback {
            width: 10px;
        }

        .picker {
            z-index: 100000;
        }

        .ui-autocomplete {
            max-height: 100px;
            overflow-y: auto;
            /* prevent horizontal scrollbar */
            overflow-x: hidden;
            /* add padding to account for vertical scrollbar */
            padding-right: 5px;
            z-index: 2147483647;
        }

        .ui-menu-item {
            padding-right: 0;
        }

        .ui-menu-divider {
            display: none;
        }
        /* IE 6 doesn't support max-height
        * we use height instead, but this forces the menu to always be this tall
        */
        * html .ui-autocomplete {
            height: 100px;
        }

        table.dataTable {
            border-collapse: collapse;
        }
        .DataTables_sort_icon {
            display: none;
        }
        #close {
            position: absolute;
            top: 0;
            right: 0px;
            background: url(../images/close2.png) no-repeat -25px 0;
            width: 30px;
            height: 30px;
            text-indent: -9999px;
            padding: 0 10px 0 0;
            cursor: pointer;
            margin: -8px 0 0 0;
        }

        .ui-autocomplete {
            font-size: 12px;
        }

        input[type=text][disabled] {
            background: #ddd;
        }
    </style>
}


<div class="container">
    <!-- Modal -->
    <div class="modal nsModal" id="success" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header modal-header-ns">
                    <div id="close" aria-hidden="true"></div>
                    <h4 class="nstitle"> <img alt="New_Sale_logo" src="~/images/New_sale.png" height="20" width="20" style="margin-right: 5px;" />New Sales</h4>
                </div>
                <div class="modal-body">
                    <div class="row-top">
                        <div class="col-sm-12">
                            <div class="row">
                                <div class="col-sm-6">
                                    <div class="col-sm-12" style="margin-bottom: 5px;">
                                        <label>Company</label>
                                        <input type="text" id="companies" class="form-control input-sm select" style="height: 30px;" />
                                        <select hidden size="10" id="CompanyList" style="border: 1px solid gray; font-size: 12px; z-index: 9999999999999; height: 200px; position: absolute; overflow-y: auto; overflow-x: hidden; background: white;">
                                            @foreach (Company company in ViewBag.CompanyList)
                                            {
                                                <option value="@company.Id" data-blacklisted="@company.BlackListed">@company.Name</option>
                                            }
                                        </select>
                                    </div>
                                    <div class="col-sm-12">
                                        <button type="button" class="btn btn-info pull-left btn-sm" id="addCompany">Add New Company</button>
                                        <button type="button" class="btn btn-info pull-right btn-sm">Refresh Company List</button>
                                    </div>
                                </div>
                                <div class="col-sm-6">
                                    <div class="col-sm-12" style="margin-bottom: 5px;">
                                        <label>Product name</label>
                                        @Html.DropDownList("Products", null, "List of Products", new { @class = "form-control input-sm" })
                                    </div>
                                    <div class="col-sm-12">
                                        <button type="button" class="btn btn-info pull-left btn-sm">Add New Product</button>
                                        <button type="button" class="btn btn-info pull-right btn-sm">Refresh Product List</button>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-sm-6">
                                    <fieldset class="fsStyle" id="blackField">
                                        <legend class="legendStyle">
                                            Sale Information
                                        </legend>
                                        <div class="col-sm-12">
                                            <div class="col-sm-6">
                                                <label>Sales Price</label>
                                            </div>
                                            <div class="col-sm-6" style="padding-right: 0;">
                                                <input id="salsePrice" type="text" maxlength="10" size="11" class="form-control input-sm text-right pull-right">
                                            </div>
                                        </div>
                                        <div class="col-sm-12" style="margin:8px 0px 0px 0px;">
                                            <div class="col-sm-7">
                                                <label style="float: left; margin-right: 7px;">Tax type</label>
                                                @Html.DropDownList("Type", null, "", new { @class = "form-control input-sm", @style = "width: 80px; font-size: 10px; padding: 0; margin-top: 3px;" })
                                            </div>
                                            <div class="col-sm-5" style="padding-right: 0; padding-left: 0; margin-left: -10px;">
                                                <label class="col-sm-3" style="padding-left: 0;text-align: left;padding-right: 0;">Amount</label>
                                                <div class="col-sm-9" style="padding-right: 0;">
                                                    <input id="amount" type="text" size="5" style="margin-left: 10px;" class="form-control input-sm text-right">
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-sm-12" style="margin:8px 0px 0px 0px;">
                                            <div class="col-sm-5">
                                                <label id="job">Job Title</label>
                                            </div>
                                            <div class="col-sm-7" style="padding-right: 0;">
                                                <input type="text" class="form-control input-sm pull-right select" disabled id="jobTitle" style="padding: 0 0 0 5px;" /><input type="hidden" id="jobId" />
                                            </div>
                                        </div>
                                        <div class="col-sm-12" style="margin:8px 0px 0px 0px;">
                                            <div class="col-sm-5">
                                                <label>Billing Person</label>
                                            </div>
                                            <div class="col-sm-7" style="padding-right: 0;">
                                                <input type="text" class="form-control input-sm pull-right select" id="billingPerson" style="padding: 0 0 0 0px;" /><input type="hidden" id="billingId" />
                                            </div>
                                        </div>
                                        <div class="col-sm-12" style="margin:8px 0px 0px 0px;">
                                            <div class="col-sm-5">
                                                <label>Designation</label>
                                            </div>
                                            <div class="col-sm-7" style="padding-right: 0;">
                                                <input id="designation" name="salse price" type="text" maxlength="19" size="19" class="form-control input-sm pull-right">
                                            </div>
                                        </div>
                                        <div class="col-sm-12" style="margin:8px 0px 0px 0px; height: 20px;">
                                            <div hidden id="workshopdateDiv">
                                                <div class="col-sm-5">
                                                    <label>Workshop Date</label>
                                                </div>
                                                <div class="col-sm-7" style="padding-right: 0;">
                                                    <input type="text" readonly id="workshopdate" maxlength="19" size="19" style="background: white;" class="form-control input-sm pull-right picker select">
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-sm-12" style="margin:8px 0px 0px 0px;">
                                            <div class="col-sm-5">
                                                <label>Ref. No</label>
                                            </div>
                                            <div class="col-sm-7" style="padding-right: 0;">
                                                <input id="refno" type="text" maxlength="19" size="19" class="form-control input-sm pull-right">
                                            </div>
                                        </div>
                                        <div class="col-sm-12" style="margin:8px 0px 0px 0px;">
                                            <div class="form-group">
                                                <label>Comments</label>
                                                <textarea class="form-control input-sm noresize" style="height: 53px;" id="comment"></textarea>
                                            </div>
                                        </div>
                                    </fieldset>
                                    <div class="col-sm-12">
                                        <button type="button" id="sale" class="btn btn-info btn-sm" style="width:100%; margin:0px 0px 5px 0px;">Sale another product</button>
                                    </div>
                                </div>
                                <div class="col-sm-6">
                                    <div class="row">
                                        <div class="col-sm-12">
                                            <fieldset class="fsStyle">
                                                <legend class="legendStyle">
                                                    This Product is valid for
                                                </legend>
                                                <div class="row">
                                                    <div class="col-sm-12">
                                                        <div class="col-sm-8">
                                                            <div class="radio">
                                                                <label><input name="duration" id="radio1" value="1" type="radio" checked>One/less than one month</label>
                                                            </div>
                                                        </div>
                                                        <div class="col-sm-4">
                                                            <label>From</label>
                                                            <input id="dp1" readonly maxlength="10" size="10" style="font-size: 11.5px; background-color: white;" class="form-control input-sm picker select" type="text">
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="col-sm-12" style="margin:10px 0px 0px 0px;">
                                                        <div class="col-sm-8">
                                                            <div class="radio">
                                                                <label><input name="duration" id="radio2" value="2" type="radio">more than one month</label>
                                                                Duration  <input maxlength="2" size="2" type="text" id="month" readonly style="text-align: center;">  months
                                                            </div>
                                                        </div>
                                                        <div class="col-sm-4">
                                                            <label>To</label>
                                                            <input id="dp2" readonly maxlength="10" style="font-size: 11.5px; background-color: white;" class="form-control input-sm picker select" size="10" type="text">
                                                        </div>
                                                    </div>
                                                </div>
                                            </fieldset>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-sm-12">
                                            <fieldset class="fsStyle">
                                                <legend class="legendStyle">
                                                    Invoice scheduling
                                                </legend>
                                                <div class="row">
                                                    <div class="col-sm-12" style="margin-top: -5px; margin-bottom: 3px;">
                                                        <div class="col-sm-8">
                                                            No. fo invoice(s) would be created
                                                        </div>
                                                        <div class="col-sm-4">
                                                            <div class="col-sm-6">
                                                                <input maxlength="5" size="5" type="text" id="noofinvoice" style="text-align: right;">
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="col-sm-12" style="margin:0px 0px 0px 14px; padding-top: 0;">
                                                        Give the schedule
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="col-sm-12" style="margin:0px -20px 0px 0px;">
                                                        <div class="col-sm-12">
                                                            <table id="editable" class="table table-bordered table-responsive" style="font-size: 10px;">
                                                                <thead>
                                                                    <tr>
                                                                        <th>SNo</th>
                                                                        <th>SDate</th>
                                                                        <th>Amount</th>
                                                                        <th>VAT</th>
                                                                    </tr>
                                                                </thead>
                                                                <tbody></tbody>
                                                            </table>
                                                        </div>
                                                    </div>
                                                </div>
                                            </fieldset>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <div class="col-sm-3 pull-left" style="padding-left: 0;">
                        <button type="button" class="btn btn-block btn-primary" id="save"><strong>Save</strong></button>
                    </div>
                    <div class="col-sm-3 pull-left" style="padding-left: 0;">
                        <button type="button" class="btn btn-block btn-primary" id="make"><strong>Make Invoice</strong></button>
                    </div>
                    <div class="col-sm-3 pull-right" style="padding-right: 0;">
                        <a role="button" class="btn btn-block btn-primary" id="exit"><strong>Exit</strong></a>
                    </div>
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->
    <!-- Modal -->
</div>

<div class="container">
    <!-- Modal -->
    <div class="modal nsModal" id="closejournal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog" style="width: 300px; margin-top: 200px;">
            <div class="modal-content">
                <div class="modal-header modal-header-ns">
                    <h4 class="nstitle">Journal Date</h4>
                </div>
                <div class="modal-body">
                    <div class="row" style="padding: 10px;">
                        <div class="col-sm-offset-2 col-sm-8">
                            <p>Give the journal date.</p>
                            <div class="col-sm-9 has-feedback" style="padding-left: 0;">
                                <input type="text" readonly id="journalDate" class="form-control input-sm picker" style="height: 25px; width: 130px; background: white; cursor: default; padding: 0 0 0 0px; text-align: center;" />
                                <span class="glyphicon glyphicon-chevron-down form-control-feedback" style="text-align: right;"></span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer" style="margin-top: -20px;">
                    <div class="col-sm-offset-2 col-sm-4 pull-left" style="padding-left: 0;">
                        <button type="button" class="btn btn-block btn-default" id="ok"><strong>Ok</strong></button>
                    </div>
                    <div class="col-sm-4 pull-left" style="padding-left: 0;">
                        <button type="button" class="btn btn-block btn-default" data-dismiss="modal"><strong>Cancel</strong></button>
                    </div>
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->
    <!-- Modal -->
</div>

<input type="hidden" id="closedate" />

@section scripts
{
    <script src="~/Scripts/jquery-ui-1.11.4.js"></script>
    <script src="~/Scripts/js/jquery.dataTables.js"></script>
    <script src="~/Scripts/js/jquery.jeditable.js"></script>
    <script src="~/Scripts/js/jquery.jeditable.datepicker.js"></script>
    <script src="~/Scripts/js/messi.min.js"></script>
    <script>
        $(document).ready(function () {
            var closingDate = '@ViewBag.ClosingDate';
            $('#dp1').datepicker({
                changeMonth: true,
                changeYear: true,
                onSelect: function (datetext, inst) {
                    calculateDuration(datetext, $("#dp2").val());
                    if (table.rows().data().length > 0) {
                        for (var i = 0; i < table.rows().data().length; i++) {
                            if (table.cell(i, 1).data() != "")
                                table.cell(i, 1).data(datetext);
                        }
                    }
                }
            });
            $('#dp2').datepicker({
                changeMonth: true,
                changeYear: true,
                onSelect: function (datetext, inst) {
                    calculateDuration($("#dp1").val(), datetext);
                }
            });
            $('#journalDate').datepicker({
                changeMonth: true,
                changeYear: true
            });

            $('#workshopdate').datepicker({
                changeMonth: true,
                changeYear: true
            });
            $(window).on('load', function () {
                getCompanies();
                $("#success").modal({
                    backdrop: 'static',
                    keyboard: false
                });
                $("#closejournal").modal({
                    backdrop: 'static',
                    keyboard: false
                });
                $("#closejournal").modal('hide');
                $('#CompanyList').css('width', ($('#companies').width() + 22) + 'px');
            });
            //$(document).click(function () {
            //    $('#success').modal('show');
            //});
            //$(document).on('keydown', function (e) {
            //    if (e.keyCode == 27)
            //        $('#success').modal('show');
            //});
            var enforceModalFocusFn = $.fn.modal.Constructor.prototype.enforceFocus;

            $.fn.modal.Constructor.prototype.enforceFocus = function () { };

            $("#close, #exit").on('click', function () {
                $('#success').modal('hide');
            });

            function pad(str, max) {
                str = str.toString();
                return str.length < max ? pad("0" + str, max) : str;
            }


            function getCompanies() {
                if ('@companyid' != 0) {
                    $('#companies').val($('#CompanyList option[value="@companyid"]').text());
                    $('#CompanyList').val('@companyid');
                    $("#Products option[value='@onlineLedgerId']").prop('selected', true);
                    $.ajax({
                        type: "Post",
                        url: '@Url.Action("GetContactOrJob", "Sale")',
                        contentType: "application/json; charset=utf-8",
                        data: JSON.stringify({ cId: '@companyid' }),
                        dataType: "json",
                        success: function (dat) {
                            var persons = [];
                            $.each(dat.ContactPersons, function (key11, value11) {
                                persons.push({ value: value11.Name, designation: value11.Designation, id: value11.Id });
                            });
                            var jobs = [];
                            $.each(dat.JobTitles, function (key22, value22) {
                                if (value22.JpId == '@onlineJobId') {
                                    $("#jobTitle").val(value22.Title);
                                    $("#job").css('color', '');
                                    $("#jobTitle").prop('disabled', false);
                                    $("#dp1").val(value22.PostingDate);
                                    $("#dp2").val(value22.ValidDate);
                                    $("#billingPerson").val(value22.CompanyName);
                                    $("#designation").val(value22.Type);
                                    $("#jobId").val(value22.JpId);
                                    $("#radio2").prop('checked', true);
                                }
                                jobs.push({ value: value22.Title, jpid: value22.JpId, billingcontact: value22.CompanyName, designation: value22.Type, postingdate: value22.PostingDate, validdate: value22.ValidDate });
                            });

                            $("#billingPerson").autocomplete({
                                source: persons,
                                minLength: 0,
                                select: function (event, ui) {
                                    $("#designation").val(ui.item.designation);
                                    $("#billingId").val(ui.item.id);
                                    $(this).blur();
                                }
                            }).focus(function () {
                                $(this).autocomplete("search", "");
                            });

                            $("#jobTitle").autocomplete({
                                source: jobs,
                                minLength: 0,
                                select: function (event, ui) {
                                    $("#dp1").val(ui.item.postingdate);
                                    $("#dp2").val(ui.item.validdate);
                                    $("#jobId").val(ui.item.jpid);
                                    $(this).blur();
                                }
                            }).focus(function () {
                                $(this).autocomplete("search", "");
                            });
                            var val1 = $("#dp1").val();
                            var val2 = $("#dp2").val();
                            var date1 = val1.split('/');
                            var date2 = val2.split('/');
                            var date = new Date(date1[2], (date1[0] - 1), date1[1]);
                            var nextdate = new Date(date2[2], (date2[0] - 1), date2[1]);
                            var dif = (nextdate - date) / (1000 * 60 * 60 * 24);
                            var m = parseInt(dif / 30);
                            var r = dif % 30;
                            if (r >= 15)
                                m = (m + 1);
                            if (m == 0)
                                m = m + 1;
                            $("#month").val(m.toString());
                        },
                    });
                }
            }

            $(document).on('click', function () {
                if (!$('#companies').is(':focus') && !$('#CompanyList').is(':focus') && $('#CompanyList').is(':visible'))
                    $('#CompanyList').hide();
            });


            $('#CompanyList').on('click', function () {
                setOptions();
            });

            function setOptions() {
                $('#companies').val($('#CompanyList option:selected').text()).focus();
                $('#CompanyList').hide();
                if ($('#CompanyList option:selected').data('blacklisted') == 'True') {
                    var m = new Messi("<p style='text-align: justify;'>This Company is Blacklisted.<br/><br/>You can't give a sale for this Company.</p>",
                    {
                        title: 'Alert',
                        modal: true,
                        buttons: [
                            { id: 0, label: 'OK', val: 'X' }
                        ]
                    });
                    $('.messi-actions').css('float', 'left').css('margin-left', '205px');
                    $("#blackField").prop('disabled', true);
                } else {
                    $("#blackField").prop('disabled', false);
                    $.ajax({
                        type: "Post",
                        url: '@Url.Action("GetContactOrJob", "Sale")',
                        contentType: "application/json; charset=utf-8",
                        data: JSON.stringify({ cId: $('#CompanyList').val() }),
                        dataType: "json",
                        success: function (dt) {
                            var persons = [];
                            $.each(dt.ContactPersons, function (key1, value1) {
                                persons.push({ value: value1.Name, designation: value1.Designation, id: value1.Id });
                            });
                            $("#billingPerson").autocomplete({
                                source: persons,
                                minLength: 0,
                                select: function (ev, u) {
                                    $("#designation").val(u.item.designation);
                                    $("#billingId").val(u.item.id);
                                    $('#billingPerson').blur();
                                }
                            }).focus(function () {
                                $('#billingPerson').autocomplete("search", "");
                            });
                            $("#billingPerson").val('');
                            $("#designation").val('');
                        },
                    });
                    saveEnableDisable();
                }
                $("#make").prop('disabled', true);
            }

            $("#CompanyList").on('change', function () {
                $('#companies').val($('#CompanyList option:selected').text());
            });
            $("#CompanyList").on('keydown', function (e) {
                if (e.keyCode == 13) {
                    setOptions();
                } else if (e.keyCode == 27) {
                    $("#CompanyList").hide();
                    $("#companies").focus();
                }
            });
            $('#companies').on('click', function () {
                var str = $(this).val();
                $.each($('#CompanyList option'), function () {
                    if ($(this).text().toLowerCase().indexOf(str.toLowerCase()) == 0) {
                        $(this).prop('selected', true);
                        return false;
                    }
                    return true;
                });

                if ($('#CompanyList').is(':visible'))
                    $('#CompanyList').hide();
                else
                    $('#CompanyList').show().focus();
            });
            $('#companies').on('keyup', function (e) {
                if (e.keyCode != 13 && e.keyCode != 27) {
                    var str = $(this).val();
                    $.each($('#CompanyList option'), function () {
                        if ($(this).text().toLowerCase().indexOf(str.toLowerCase()) == 0) {
                            $(this).prop('selected', true);
                            return false;
                        }
                        return true;
                    });
                    $('#CompanyList').show();
                }
            });

            $("#amount").prop('disabled', true);
            $("#salsePrice, #amount").val('0.00');
            $("#month").val('1');
            var today = new Date();
            var toDate = pad((today.getMonth() + 1), 2) + "/" + pad(today.getDate(), 2) + "/" + today.getFullYear();
            $("#dp1, #dp2, #workshopdate").val(toDate);
            $("#radio2").prop('checked', true);
            $("#job").css('color', 'gray');
            $("#jobTitle").prop('disabled', true);
            $("#save").prop('disabled', true);
            $("#make").prop('disabled', true);

            var table = $("#editable").DataTable({
                "bFilter": false,
                "bInfo": false,
                "scrollY": "90px",
                "scrollCollapse": true,
                "paging": false,
                "jQueryUI": true,
                "aoColumns": [
                    { "bSortable": true, "sType": "nullable" }
                ],
                columnDefs: [
                    { sortable: false, targets: [0, 1, 2, 3] },
                    { className: "aright", targets: [2, 3] },
                    { className: "acenter", targets: [0, 1] },
                    { "width": "10%", "targets": [0] },
                    { "width": "30%", "targets": [1] },
                    { "width": "30%", "targets": [2] },
                    { "width": "30%", "targets": [3] }
                ]
            });

            function tableClear() {
                table.clear().draw();
                for (var i = 1; i <= 5; i++) {
                    table.row.add(["", "", "", ""]).draw();
                }
                $('table:not(#editable), .dataTables_scrollHeadInner').css('width', '313px');
                $('.dataTables_scrollHeadInner').css('padding-right', '17px');
                $('.dataTables_scrollBody').css('overflow-y', 'scroll').css('overflow-x', 'hidden');
            }

            tableClear();
            $.fn.dataTableExt.oSort['nullable-asc'] = function (a, b) {
                if (a == '')
                    return 1;
                else if (b == '')
                    return -1;
                else {
                    var ia = parseInt(a);
                    var ib = parseInt(b);
                    return (ia < ib) ? -1 : ((ia > ib) ? 1 : 0);
                }
            }

            $.fn.dataTableExt.oSort['nullable-desc'] = function (a, b) {
                if (a == '')
                    return 1;
                else if (b == '')
                    return -1;
                else {
                    var ia = parseInt(a);
                    var ib = parseInt(b);
                    return (ia > ib) ? -1 : ((ia < ib) ? 1 : 0);
                }
            }

            $('#editable tbody').on('click', 'tr', function () {
                if (table.cell($(this), 0).data() != "") {
                    if ($(this).hasClass('selected')) {
                        $(this).removeClass('selected');
                    } else {
                        table.$('tr.selected').removeClass('selected');
                        $(this).addClass('selected');
                    }
                }
            });

            function centerSuccess() {
                $("#success").css('display', 'block');
                var $dialog = $('.modal').find(".modal-dialog");
                var offset = ($(window).height() - $dialog.height()) / 2;
                // Center modal vertically in window
                if (offset >= 0)
                    $dialog.css("margin-top", offset);
            }

            function centerSuccess2() {
                $("#closejournal").css('display', 'block');
                var $dialog = $("#closejournal").find(".modal-dialog");
                var offset = ($(window).height() - $dialog.height()) / 2;
                // Center modal vertically in window
                if (offset >= 0)
                    $dialog.css("margin-top", offset);
            }

            centerSuccess();
            $(window).on("resize", function () {
                centerSuccess();
                $('#CompanyList').css('width', ($('#companies').width() + 22) + 'px');
            });

            function calculateDuration(first, second) {
                var date1 = first.split('/');
                var date2 = second.split('/');
                var date = new Date(date1[2], (date1[0] - 1), date1[1]);
                var nextdate = new Date(date2[2], (date2[0] - 1), date2[1]);
                var dif = (nextdate - date) / (1000 * 60 * 60 * 24);
                var m = parseInt(dif / 30);
                var r = dif % 30;
                if (r >= 15)
                    m = (m + 1);
                if (m == 0)
                    m = m + 1;
                $("#month").val(m.toString());
            }

            $('input:radio[name="duration"]').on('change', function () {
                if ($(this).val() == "1") {
                    $("#month").val('1');
                    $("#dp2").val(toDate);
                    $("#dp2, #month").css('background', '');
                    $("#dp2, #month").prop('disabled', true);
                } else {
                    $("#dp2, #month").css('background', 'white');
                    $("#dp2, #month").prop('disabled', false);
                }
            });

            $("#Type").on('change', function () {
                if ($(this).val() != "")
                    $("#amount").prop('disabled', false);
                else
                    $("#amount").prop('disabled', true);
            });

            $("#Products").on('change', function () {
                var value = $(this).val();
                if (value != "") {
                    $.ajax({
                        type: "Post",
                        url: '@Url.Action("CheckJobTitle", "Sale")',
                        contentType: "application/json; charset=utf-8",
                        data: JSON.stringify({ productId: value }),
                        dataType: "json",
                        success: function (data) {
                            if (data.length == 0) {
                                $("#job").css('color', 'gray');
                                $("#jobTitle").prop('disabled', true);
                                $("#job").html('Job Title');
                                $("#workshopdateDiv").hide();
                            } else {
                                $("#job").css('color', '');
                                $("#jobTitle").prop('disabled', false);
                                if (data[0].Id == 301) {
                                    $("#job").html('Workshop Title');
                                    $("#workshopdateDiv").show();
                                } else {
                                    $("#job").html('Job Title');
                                    $("#workshopdateDiv").hide();
                                }
                            }
                        },
                    });
                } else {
                    $("#job").css('color', 'gray');
                    $("#jobTitle").prop('disabled', true);
                    $("#job").html('Job Title');
                    $("#workshopdateDiv").hide();
                }
                saveEnableDisable();
                $("#make").prop('disabled', true);
            });

            $("#noofinvoice").val('1');
            $("#salsePrice, #amount").on('focusout', function () {
                fillTable();
                saveEnableDisable();
            });
            $("#salsePrice, #amount").on('keypress', function (e) {
                if (e.keyCode == 13) {
                    fillTable();
                    saveEnableDisable();
                }
            });

            function saveEnableDisable() {
                if ($("#Products").val() != "" && $("#companies").val() != "" && table.cell(0, 0).data() != "") {
                    $("#save").prop('disabled', false);
                } else {
                    $("#save").prop('disabled', true);
                }
            }

            function fillTable() {
                var val = parseFloat($("#salsePrice").val());
                if ($("#salsePrice").val() != "" && val != 0) {
                    fill();
                    $("#salsePrice").val(parseFloat($("#salsePrice").val()).toFixed(2));
                    $("#amount").val(parseFloat($("#amount").val()).toFixed(2));
                } else {
                    tableClear();
                }
            }

            $("#noofinvoice").on('focusout', function () {
                if ($(this).val() == "" || parseInt($(this).val()) == 0)
                    $(this).val('1');
                if (parseFloat($("#salsePrice").val()) > 0) {
                    fill();
                } else {
                    $(this).val('1');
                }
            });

            function fill() {
                var no = parseInt($("#noofinvoice").val());
                if (no > 12) {
                    $("#noofinvoice").val('12');
                    no = 12;
                }
                var prices = parseFloat($("#salsePrice").val()) / no;
                var vats = parseFloat($("#amount").val()) / no;
                table.clear().draw();
                for (var i = 1; i <= no; i++) {
                    table.row.add([i, $("#dp1").val(), prices.toFixed(2), vats.toFixed(2)]).draw();
                }

                if (no < 5) {
                    for (var j = 1; j <= 5 - no; j++) {
                        table.row.add(["", "", "", ""]).draw();
                    }
                }

                for (var k = 1; k <= table.rows().data().length; k++) {
                    if (table.cell(k - 1, 0).data() != "") {
                        $('#editable tr:nth-child(' + k + ') td:nth-child(2)').editable(function (value, settings) {
                            return (value);
                        }, {
                            type: 'datepicker',
                            datepicker: {
                                changeMonth: true,
                                changeYear: true
                            },
                            event: "dblclick",
                            tooltip: "Double click to edit"
                        });

                        $('#editable tr:nth-child(' + k + ') td:nth-child(3)').editable(function (value, settings) {
                            var amount = parseFloat(value);
                            table.cell($(this).parents('tr'), 2).data(amount.toFixed(2));
                            //var prevAmount = parseFloat(table.cell($(this), 1).data());
                            //var dif = amount - prevAmount;
                            return (amount.toFixed(2));
                        }, {
                            type: 'text',
                            event: "dblclick",
                            tooltip: "Double click to edit"
                        });
                    }
                }
            }

            $("#noofinvoice").on('keypress', function (e) {
                if (e.keyCode == 13) {
                    if (parseFloat($("#salsePrice").val()) > 0) {
                        fill();
                        $(this).blur();
                    }
                } else if (!$.isNumeric(String.fromCharCode(e.which)))
                    return false;
                return true;
            });

            $("#save").on('click', function () {
                var isExist = false;
                $.each($('#CompanyList option'), function () {
                    if ($(this).text() == $('#companies').val()) {
                        $(this).prop('selected', true);
                        isExist = true;
                        return false;
                    }
                    return true;
                });
                if (isExist == false) {
                    var m101 = new Messi("<p style='text-align: justify;'>The Entered Company doesn't exist.</p>",
                    {
                        title: 'Not Exist',
                        modal: true,
                        buttons: [
                            { id: 0, label: 'OK', val: 'X' }
                        ]
                    });
                    $('.messi-actions').css('float', 'left').css('margin-left', '205px');
                    return false;
                }
                var l = 0;
                var msg = new Messi('Are you sure to make new sale ?',
                {
                    title: 'Confirm',
                    modal: true,
                    buttons: [
                        { id: 0, label: 'Yes', val: 'Y' },
                        { id: 1, label: 'No', val: 'N' }
                    ],
                    callback: function (val) {
                        if (l == 1)
                            return false;
                        if (val == 'Y') {
                            var access = '@accessRights.Contains("1")';
                            var total = 0.00;
                            for (var i = 0; i < table.rows().data().length; i++) {
                                if (table.cell(i, 0).data() != "")
                                    total += parseFloat(parseFloat(table.cell(i, 2).data()) + parseFloat(table.cell(i, 3).data()));
                            }
                            var fromDate = $("#dp1").val();
                            var date1 = fromDate.split('/');
                            var from = new Date(date1[2], (parseInt(date1[0]) - 1), date1[1]);
                            var toDt = $("#dp2").val();
                            var date2 = toDt.split('/');
                            var to = new Date(date2[2], (parseInt(date2[0]) - 1), date2[1]);

                            if (access == 'False') {
                                var m = new Messi("<p style='text-align: justify;'>Sorry, You have no permission to insert a record.</p>",
                                {
                                    title: 'Error',
                                    modal: true,
                                    buttons: [
                                        { id: 0, label: 'OK', val: 'X' }
                                    ]
                                });
                                $('.messi-actions').css('float', 'left').css('margin-left', '205px');
                            } else if ($("#dp2").is(':enabled') && from >= to) {
                                var m1 = new Messi("<p style='text-align: justify;'>'<strong>From date</strong>' should not greater than or equal to '<strong>To date</strong>'</p>",
                                {
                                    title: 'Error',
                                    modal: true,
                                    buttons: [
                                        { id: 0, label: 'OK', val: 'X' }
                                    ]
                                });
                                $('.messi-actions').css('float', 'left').css('margin-left', '205px');
                            } else if (table.rows().data().length <= 0) {
                                var m2 = new Messi("<p style='text-align: justify;'>You must fulfil Schedule of Invoice first, then save this sales information.</p>",
                                {
                                    title: 'Error',
                                    modal: true,
                                    buttons: [
                                        { id: 0, label: 'OK', val: 'X' }
                                    ]
                                });
                                $('.messi-actions').css('float', 'left').css('margin-left', '205px');
                            } else if (parseFloat(total) != parseFloat(parseFloat($("#salsePrice").val()) + parseFloat($("#amount").val()))) {
                                var m3 = new Messi("<p style='text-align: justify;'>The total amount of invoice scheduler is not equal to sales price.</p>",
                                {
                                    title: 'Error',
                                    modal: true,
                                    buttons: [
                                        { id: 0, label: 'OK', val: 'X' }
                                    ]
                                });
                                $('.messi-actions').css('float', 'left').css('margin-left', '205px');
                            } else if ($("#billingPerson").val() == "") {
                                var m4 = new Messi("<p style='text-align: justify;'>You must give the name of '<strong>Billing Person</strong>'.</p>",
                                {
                                    title: 'Error',
                                    modal: true,
                                    buttons: [
                                        { id: 0, label: 'OK', val: 'X' }
                                    ]
                                });
                                $('.messi-actions').css('float', 'left').css('margin-left', '205px');
                            } else if ($("#amount").is(':enabled') && parseFloat($("#amount").val()) == "0.00") {
                                var m5 = new Messi("<p style='text-align: justify;'>You must give the '<strong>VAT Amount</strong>'.</p>",
                                {
                                    title: 'Error',
                                    modal: true,
                                    buttons: [
                                        { id: 0, label: 'OK', val: 'X' }
                                    ]
                                });
                                $('.messi-actions').css('float', 'left').css('margin-left', '205px');
                            } else if ($("#jobTitle").is(':enabled') && $("#jobTitle").val() == "") {
                                var title = 'Job Title';
                                if ($("#Products").val() == '301') {
                                    title = 'Workshop Title';
                                }
                                var m6 = new Messi("<p style='text-align: justify;'>You must give the '<strong>" + title + "</strong>'.</p>",
                                {
                                    title: 'Error',
                                    modal: true,
                                    buttons: [
                                        { id: 0, label: 'OK', val: 'X' }
                                    ]
                                });
                                $('.messi-actions').css('float', 'left').css('margin-left', '205px');
                            } else {
                                centerSuccess2();
                                $("#closejournal").modal('show');
                            }
                            l = 1;
                        }
                        return true;
                    }
                });
                return false;
            });

            $("#journalDate").val(toDate);
            $("#ok").on('click', function () {
                var fromDate = $("#journalDate").val();
                var date1 = fromDate.split('/');
                var from = new Date(date1[2], (parseInt(date1[0]) - 1), date1[1]);
                var toDt = closingDate;
                var date2 = toDt.split('/');
                var to = new Date(date2[2], (parseInt(date2[0]) - 1), date2[1]);
                if (from <= to) {
                    var m = new Messi("<p style='text-align: justify;'>You cannot post journal on or before '<strong>" + toDt + "</strong>'.<br/>Please give another date.</p>",
                    {
                        title: 'Error',
                        modal: true,
                        buttons: [
                            { id: 0, label: 'OK', val: 'X' }
                        ]
                    });
                    $('.messi-actions').css('float', 'left').css('margin-left', '205px');
                } else {
                    var userId = '@user.UserId';
                    var cId = $("#CompanyList").val();
                    var pCode = $("#Products").val();
                    var frDate = $("#dp1").val();
                    var tDate = "";
                    if ($("#dp2").is(':enabled'))
                        tDate = $("#dp2").val();
                    var jrDate = fromDate;
                    var salesPrice = $("#salsePrice").val();
                    var billingPerson = $("#billingPerson").val();
                    var designation = $("#designation").val();
                    var comment = $("#comment").val();
                    var duration = $("#month").val();
                    var noofinvoice = $("#noofinvoice").val();
                    var refNo = $("#refno").val();
                    var typeId = $("#Type").val();
                    var vat = $("#amount").val();
                    var jpId = 0;
                    if ($("#jobId").val() != "")
                        jpId = $("#jobId").val();
                    var jTitle = $("#jobTitle").val();
                    var wDate = "";
                    if ($("#workshopdateDiv").is(':visible'))
                        wDate = $("#workshopdate").val();
                    var jsonData = { userId: userId, cId: cId, pCode: pCode, fromDate: frDate, toDate: tDate, journalDate: jrDate, salesPrice: salesPrice, billingPerson: billingPerson, designation: designation, comment: comment, duration: duration, noOfInvoice: noofinvoice, refNo: refNo, typeId: typeId, vat: vat, jpId: jpId, jobTitle: jTitle, workshopDate: wDate };
                    $.ajax({
                        type: "Post",
                        url: '@Url.Action("Save", "Sale")',
                        contentType: "application/json; charset=utf-8",
                        data: JSON.stringify(jsonData),
                        dataType: "json",
                        success: function (dt) {
                            var mm = new Messi("<p style='text-align: justify;'>All information has been saved successfully.</p>",
                            {
                                title: 'Success',
                                modal: true,
                                buttons: [
                                    { id: 0, label: 'OK', val: 'X' }
                                ]
                            });
                            $('.messi-actions').css('float', 'left').css('margin-left', '205px');
                            $("#closejournal").modal('hide');
                            $("#save").prop('disabled', true);
                            $("#make").prop('disabled', false);
                        },
                    });
                }
            });

            $("#addCompany").on('click', function () {
                window.open('@Url.Action("Index", "Company")');
            });

            $("#make").on('click', function () {
                window.location = '../Invoice/Create?companyId=' + $("#CompanyList").val();
            });
            $("#sale").on('click', function () {
                $('#companies').val('');
                $("#Products option[value='']").prop('selected', true);
                $('#salsePrice, #amount').val('0.00');
                $("#Type option[value='']").prop('selected', true);
                $("#amount").prop('disabled', true);
                $("#jobTitle, #designation, #billingPerson, #refno, #comment").val('');
                $("#jobTitle").prop('disabled', true);
                $("#month").val('1');
                $("#month").prop('disabled', false);
                $("#dp1, #dp2, #workshopdate").val(toDate);
                $("#dp2").css('background', 'white');
                $("#dp2").prop('disabled', false);
                $("#noofinvoice").val('1');
                tableClear();
                $("#workshopdateDiv").hide();
                $("#job").html('Job Title');
                $("#save, #make").prop('disabled', true);
            });
        });
    </script>
}

